<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Typing Speed Test</title>
  <style>
    :root{
      --bg:#ffffff;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --quoteBg:#f7f7f7;
      --inputBg:#ffffff;
      --btn:#111827;
      --btnText:#ffffff;
      --btn2:#e5e7eb;
      --btn2Text:#111827;
      --correct:#1a7f37;
      --wrong:#b42318;
      --overlay: rgba(17,24,39,0.72);
    }
    body.dark{
      --bg:#0b1220;
      --card:#0f172a;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --border:#243042;
      --quoteBg:#111c33;
      --inputBg:#0b1220;
      --btn:#e5e7eb;
      --btnText:#111827;
      --btn2:#243042;
      --btn2Text:#e5e7eb;
      --correct:#22c55e;
      --wrong:#fb7185;
      --overlay: rgba(0,0,0,0.72);
    }

    body{
      font-family: system-ui, Arial;
      max-width: 900px;
      margin: 40px auto;
      padding: 0 16px;
      background: var(--bg);
      color: var(--text);
    }
    .topbar{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .muted{ color: var(--muted); font-size: 14px; }
    .card{
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 16px;
      background: var(--card);
    }
    .quote{
      font-size: 18px;
      line-height: 1.6;
      padding: 12px;
      border-radius: 12px;
      background: var(--quoteBg);
      border: 1px solid var(--border);
    }
    .quote span.correct{ color: var(--correct); }
    .quote span.wrong{ color: var(--wrong); text-decoration: underline; }

    textarea{
      width: 100%;
      min-height: 120px;
      margin-top: 12px;
      padding: 12px;
      font-size: 16px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--inputBg);
      color: var(--text);
      outline: none;
    }
    textarea:disabled{ opacity: 0.7; }

    .row{ display:flex; gap:12px; flex-wrap:wrap; margin-top: 12px; }
    .stat{
      flex: 1;
      min-width: 160px;
      padding: 12px;
      border-radius: 12px;
      background: color-mix(in srgb, var(--card) 85%, var(--quoteBg) 15%);
      border: 1px solid var(--border);
    }

    button{
      padding: 10px 14px;
      border: 1px solid transparent;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
    }
    button.primary{ background: var(--btn); color: var(--btnText); }
    button.secondary{ background: var(--btn2); color: var(--btn2Text); border-color: var(--border); }
    button.danger{ background: transparent; color: var(--wrong); border-color: var(--border); }
    button:active{ transform: translateY(1px); }

    .toggle{
      display:flex; align-items:center; gap:10px;
      border: 1px solid var(--border);
      padding: 8px 10px;
      border-radius: 12px;
      background: var(--card);
    }
    .toggle input{ width: 18px; height: 18px; }

    /* Overlay (Countdown + Results) */
    .overlay{
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: var(--overlay);
      padding: 16px;
      z-index: 999;
    }
    .overlay.show{ display: flex; }
    .modal{
      width: min(520px, 100%);
      border: 1px solid var(--border);
      border-radius: 16px;
      background: var(--card);
      padding: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    }
    .modal h2{ margin: 0 0 8px; }
    .bigNumber{
      font-size: 54px;
      font-weight: 800;
      letter-spacing: -1px;
      margin: 8px 0;
      text-align: center;
    }
    .center{ text-align:center; }
    .divider{ height: 1px; background: var(--border); margin: 12px 0; }
  </style>
</head>
<body>

  <div class="topbar">
    <div>
      <h1 style="margin:0;">Typing Speed Test</h1>
      <p class="muted" style="margin:6px 0 0;">Countdown starts when you press Start. High score is saved.</p>
    </div>

    <label class="toggle" title="Toggle dark mode">
      <input id="themeToggle" type="checkbox" />
      <span class="muted">Dark mode</span>
    </label>
  </div>

  <div class="card" style="margin-top:16px;">
    <div id="quote" class="quote"></div>

    <textarea id="input" placeholder="Click Start, then begin typing..." disabled></textarea>

    <div class="row">
      <div class="stat"><strong>Time</strong><div><span id="time">60</span>s</div></div>
      <div class="stat"><strong>WPM</strong><div id="wpm">0</div></div>
      <div class="stat"><strong>Accuracy</strong><div><span id="accuracy">100</span>%</div></div>
      <div class="stat"><strong>Errors</strong><div id="errors">0</div></div>
      <div class="stat"><strong>High Score</strong><div><span id="highWpm">â€”</span> WPM <span class="muted" id="highAcc"></span></div></div>
    </div>

    <div class="row">
      <button id="startBtn" class="primary">Start</button>
      <button id="restartBtn" class="secondary">Restart</button>
      <button id="newQuoteBtn" class="secondary">New Quote</button>
      <button id="resetHighBtn" class="danger">Reset High Score</button>
    </div>

    <p class="muted" style="margin:12px 0 0;">
      WPM uses the standard formula: (characters Ã· 5) Ã· minutes elapsed.
    </p>
  </div>

  <!-- Overlay used for countdown and results -->
  <div id="overlay" class="overlay" role="dialog" aria-modal="true" aria-live="polite">
    <div class="modal" id="overlayModal"></div>
  </div>

<script>
  // ---- Settings ----
  const TEST_DURATION = 60; // seconds
  const COUNTDOWN_FROM = 3;

  const QUOTES = [
    "The quick brown fox jumps over the lazy dog.",
    "Practice makes progress, not perfection.",
    "A small step each day adds up to big results.",
    "Good code is clear, simple, and easy to maintain.",
    "Focus on accuracy first; speed will follow naturally.",
    "Consistency beats intensity when you are learning new skills.",
    "Great things are built one careful improvement at a time.",
    "Typing is a skillâ€”train it daily and measure your progress.",
    "Keep your hands relaxed and let rhythm guide your speed.",
    "Small bugs are teachers; fix them and you level up."
  ];

  // ---- DOM ----
  const quoteEl = document.getElementById("quote");
  const inputEl = document.getElementById("input");
  const timeEl = document.getElementById("time");
  const wpmEl = document.getElementById("wpm");
  const accuracyEl = document.getElementById("accuracy");
  const errorsEl = document.getElementById("errors");
  const startBtn = document.getElementById("startBtn");
  const restartBtn = document.getElementById("restartBtn");
  const newQuoteBtn = document.getElementById("newQuoteBtn");
  const resetHighBtn = document.getElementById("resetHighBtn");

  const themeToggle = document.getElementById("themeToggle");
  const highWpmEl = document.getElementById("highWpm");
  const highAccEl = document.getElementById("highAcc");

  const overlay = document.getElementById("overlay");
  const overlayModal = document.getElementById("overlayModal");

  // ---- State ----
  let targetText = "";
  let timer = null;
  let timeLeft = TEST_DURATION;
  let startedAt = null; // timestamp (ms)
  let countdownTimer = null;
  let running = false;

  // ---- LocalStorage keys ----
  const THEME_KEY = "typingTheme";
  const HIGH_KEY = "typingHighScore"; // JSON: { wpm, accuracy }

  // ---- Theme (saved) ----
  const savedTheme = localStorage.getItem(THEME_KEY); // "dark" or "light"
  if (savedTheme === "dark") {
    document.body.classList.add("dark");
    themeToggle.checked = true;
  }
  themeToggle.addEventListener("change", () => {
    document.body.classList.toggle("dark", themeToggle.checked);
    localStorage.setItem(THEME_KEY, themeToggle.checked ? "dark" : "light");
  });

  // ---- High Score ----
  function getHighScore() {
    try {
      const raw = localStorage.getItem(HIGH_KEY);
      return raw ? JSON.parse(raw) : null;
    } catch {
      return null;
    }
  }

  function setHighScore(score) {
    localStorage.setItem(HIGH_KEY, JSON.stringify(score));
    renderHighScore();
  }

  function renderHighScore() {
    const hs = getHighScore();
    if (!hs) {
      highWpmEl.textContent = "â€”";
      highAccEl.textContent = "";
      return;
    }
    highWpmEl.textContent = String(hs.wpm);
    highAccEl.textContent = `(${hs.accuracy}%)`;
  }

  function shouldBeatHighScore(current, high) {
    if (!high) return true;
    if (current.wpm > high.wpm) return true;
    if (current.wpm < high.wpm) return false;
    // tie-break by accuracy
    return current.accuracy > high.accuracy;
  }

  // ---- Overlay helpers ----
  function showOverlay(html) {
    overlayModal.innerHTML = html;
    overlay.classList.add("show");
  }
  function hideOverlay() {
    overlay.classList.remove("show");
    overlayModal.innerHTML = "";
  }

  // ---- Core functions ----
  function pickQuote() {
    return QUOTES[Math.floor(Math.random() * QUOTES.length)];
  }

  function renderQuote(text) {
    quoteEl.innerHTML = "";
    for (const ch of text) {
      const s = document.createElement("span");
      s.textContent = ch;
      quoteEl.appendChild(s);
    }
  }

  function resetStatsUI() {
    timeEl.textContent = timeLeft;
    wpmEl.textContent = "0";
    accuracyEl.textContent = "100";
    errorsEl.textContent = "0";
  }

  function clearAllTimers() {
    clearInterval(timer);
    timer = null;
    clearInterval(countdownTimer);
    countdownTimer = null;
  }

  function resetTest(keepQuote = false) {
    clearAllTimers();
    running = false;
    timeLeft = TEST_DURATION;
    startedAt = null;

    if (!keepQuote) {
      targetText = pickQuote();
      renderQuote(targetText);
    } else {
      quoteEl.querySelectorAll("span").forEach(s => s.classList.remove("correct", "wrong"));
    }

    inputEl.value = "";
    inputEl.disabled = true;
    inputEl.placeholder = "Click Start, then begin typing...";

    resetStatsUI();
    hideOverlay();
  }

  function computeStats(typed) {
    let correctChars = 0;
    let wrongChars = 0;

    const spans = quoteEl.querySelectorAll("span");

    for (let i = 0; i < spans.length; i++) {
      const expected = targetText[i];
      const got = typed[i];

      spans[i].classList.remove("correct", "wrong");

      if (got == null) continue;

      if (got === expected) {
        correctChars++;
        spans[i].classList.add("correct");
      } else {
        wrongChars++;
        spans[i].classList.add("wrong");
      }
    }

    const totalTyped = typed.length;
    const accuracy = totalTyped === 0 ? 100 : Math.round((correctChars / totalTyped) * 100);

    const elapsedSeconds = startedAt ? (Date.now() - startedAt) / 1000 : 0;
    const minutes = Math.max(elapsedSeconds / 60, 1/60);
    const wpm = Math.round((totalTyped / 5) / minutes);

    return { correctChars, wrongChars, accuracy, wpm, totalTyped };
  }

  function updateLiveStats() {
    const typed = inputEl.value;
    const { wrongChars, accuracy, wpm } = computeStats(typed);
    errorsEl.textContent = String(wrongChars);
    accuracyEl.textContent = String(accuracy);
    wpmEl.textContent = String(wpm);
  }

  function beginCountdownThenStart() {
    if (running) return;

    // If the overlay is open from previous results, close it
    hideOverlay();

    // Prepare UI for countdown
    inputEl.disabled = true;
    inputEl.value = "";
    inputEl.placeholder = "Get ready...";
    quoteEl.querySelectorAll("span").forEach(s => s.classList.remove("correct", "wrong"));
    resetStatsUI();

    let count = COUNTDOWN_FROM;

    showOverlay(`
      <h2 class="center">Get Ready</h2>
      <div class="bigNumber" id="countNum">${count}</div>
      <p class="muted center">Starting in...</p>
    `);

    // Use interval to update countdown
    countdownTimer = setInterval(() => {
      count--;

      const numEl = document.getElementById("countNum");
      if (!numEl) return;

      if (count > 0) {
        numEl.textContent = String(count);
      } else if (count === 0) {
        numEl.textContent = "Go!";
      } else {
        // start test
        clearInterval(countdownTimer);
        countdownTimer = null;
        hideOverlay();
        startTestNow();
      }
    }, 1000);
  }

  function startTestNow() {
    if (running) return;
    running = true;

    inputEl.disabled = false;
    inputEl.focus();

    startedAt = Date.now();
    timeLeft = TEST_DURATION;
    timeEl.textContent = timeLeft;

    timer = setInterval(() => {
      timeLeft--;
      timeEl.textContent = timeLeft;

      // update stats even if they pause typing
      updateLiveStats();

      if (timeLeft <= 0) finishTest("Time is up!");
    }, 1000);
  }

  function finishTest(reasonText = "Finished!") {
    clearAllTimers();
    running = false;

    inputEl.disabled = true;
    inputEl.blur();

    // Final stats snapshot
    const typed = inputEl.value;
    const final = computeStats(typed);

    // High score update
    const high = getHighScore();
    const currentScore = { wpm: final.wpm, accuracy: final.accuracy };

    const isNewHigh = shouldBeatHighScore(currentScore, high);
    if (isNewHigh) setHighScore(currentScore);
    renderHighScore();

    showOverlay(`
      <h2 class="center">Results</h2>
      <p class="muted center" style="margin-top:0;">${reasonText}</p>

      <div class="divider"></div>

      <div class="row" style="margin-top:0;">
        <div class="stat"><strong>Final WPM</strong><div style="font-size:28px;font-weight:800;">${final.wpm}</div></div>
        <div class="stat"><strong>Final Accuracy</strong><div style="font-size:28px;font-weight:800;">${final.accuracy}%</div></div>
      </div>
      <div class="row">
        <div class="stat"><strong>Errors</strong><div style="font-size:22px;font-weight:700;">${final.wrongChars}</div></div>
        <div class="stat"><strong>Typed</strong><div style="font-size:22px;font-weight:700;">${final.totalTyped} chars</div></div>
      </div>

      <div class="divider"></div>

      <p class="center" style="margin:0;">
        ${isNewHigh ? "<strong>ðŸŽ‰ New High Score!</strong>" : "<span class='muted'>Keep practicing â€” youâ€™ll beat it.</span>"}
      </p>

      <div class="row">
        <button class="primary" id="playAgainBtn">Play Again</button>
        <button class="secondary" id="newQuoteFromResultsBtn">New Quote</button>
      </div>
    `);

    // Hook up modal buttons
    document.getElementById("playAgainBtn").addEventListener("click", () => {
      hideOverlay();
      resetTest(true);
      beginCountdownThenStart();
    });

    document.getElementById("newQuoteFromResultsBtn").addEventListener("click", () => {
      hideOverlay();
      resetTest(false);
      beginCountdownThenStart();
    });
  }

  // ---- Events ----
  inputEl.addEventListener("input", () => {
    if (!startedAt || !running) return;
    updateLiveStats();

    // optional: finish early when they complete the quote
    if (inputEl.value.length >= targetText.length) {
      finishTest("Quote completed!");
    }
  });

  startBtn.addEventListener("click", beginCountdownThenStart);
  restartBtn.addEventListener("click", () => {
    resetTest(true);
    beginCountdownThenStart();
  });
  newQuoteBtn.addEventListener("click", () => {
    resetTest(false);
    beginCountdownThenStart();
  });

  resetHighBtn.addEventListener("click", () => {
    localStorage.removeItem(HIGH_KEY);
    renderHighScore();
  });

  // ---- Init ----
  function init() {
    renderHighScore();
    resetTest(false);
  }
  init();
</script>
</body>
</html>
